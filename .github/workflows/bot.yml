name: LiveMesterBot (batch)

# --- P√°rhuzamos fut√°sok tilt√°sa ---
concurrency:
  group: livemesterbot
  cancel-in-progress: true

# --- Id≈ëz√≠tett √©s k√©zi futtat√°s ---
on:
  schedule:
    - cron: "*/15 9-22 * * *"   # 15 percenk√©nt (10:00‚Äì23:00 Budapest id≈ë)
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # --- Repo let√∂lt√©se ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Python k√∂rnyezet telep√≠t√©se ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- F√ºgg≈ës√©gek telep√≠t√©se ---
      - name: Install dependencies
        run: pip install -r requirements.txt

      # --- LiveMesterBot futtat√°sa ---
      - name: Run LiveMesterBot (short 10-min session)
        run: python livemesterbot.py
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: api-football-v1.p.rapidapi.com

          # --- Be√°ll√≠t√°sok ---
          POLL_SECONDS: "180"                # lek√©rdez√©senk√©nt 3 perc
          ACTIVE_HOURS_START: "10:00"
          ACTIVE_HOURS_END: "23:00"
          PEAK_HOURS_START: "18:00"
          PEAK_HOURS_END: "22:00"
          PEAK_POLL_SECONDS: "90"            # cs√∫csid≈ëben 1.5 percenk√©nt
          MAX_FIXTURES_PER_CYCLE: "10"
          PEAK_MAX_FIXTURES_PER_CYCLE: "15"
          STATS_COOLDOWN_MIN: "6"
          TIMEZONE: Europe/Budapest

          # --- Vez√©rl≈ë flag-ek ---
          RUN_MINUTES: "10"                  # 10 perc fut√°s, majd le√°ll√°s
          MUTE_NO_SIGNAL: "1"                # ne k√ºldj√∂n 'nincs adat' √ºzenetet
          SEND_ONLINE_ON_START: "1"          # indul√°skor k√ºld egy 'online' √ºzenetet

      # --- Napl√≥ commit√°l√°sa a repo-ba nap szerint ---
      - name: Commit logs to repo (data/YYYY-MM-DD/events.csv)
        if: always()   # akkor is fusson, ha nem volt tal√°lat
        run: |
          set -e
          DATE=$(TZ=Europe/Budapest date +%F)
          mkdir -p "data/$DATE"
          TARGET="data/$DATE/events.csv"

          if [ -f logs/events.csv ]; then
            echo "üìÅ M√°sol√°s a data/$DATE mapp√°ba..."
            if [ -f "$TARGET" ]; then
              # fejl√©c elhagy√°sa a m√°sodik √©s tov√°bbi appendn√©l
              tail -n +2 logs/events.csv >> "$TARGET"
            else
              cp logs/events.csv "$TARGET"
            fi

            echo "üìù Commit√°l√°s GitHubra..."
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add "$TARGET"
            git commit -m "chore(data): append events $DATE [skip ci]" || echo "Nincs √∫j adat commit√°lva."
            git push
          else
            echo "‚ö†Ô∏è Nincs √∫j logs/events.csv ebben a fut√°sban."
          fi

      # --- Folyamat v√©ge ---
      - name: Finish
        run: echo "‚úÖ LiveMesterBot workflow complete."
