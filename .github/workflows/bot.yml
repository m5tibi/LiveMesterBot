name: LiveMesterBot

on:
  workflow_dispatch:
  schedule:
    # NAPPALI BOT – csak 05:00–23:00 (BUD) között 10 percenként
    # BUD = UTC+1 (november), ezért 04–22 UTC.
    - cron: "*/10 4-21 * * *"
    # REGGELI ÖSSZEGZŐ – minden nap 06:05 (BUD) → 05:05 UTC
    - cron: "5 5 * * *"

concurrency:
  group: livemesterbot
  cancel-in-progress: true

jobs:
  # ===========================
  # 1) NAPPALI LIVE BOT FUTÁS
  # ===========================
  run:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '*/10 4-21 * * *'
    runs-on: ubuntu-latest
    timeout-minutes: 12
    permissions:
      contents: write
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: "-1002780259470"
      TELEGRAM_ADMIN_CHAT_ID: ${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}

      RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      RAPIDAPI_HOST: "api-football-v1.p.rapidapi.com"

      TIMEZONE: "Europe/Budapest"
      ACTIVE_HOURS_START: "05:00"
      ACTIVE_HOURS_END:   "23:00"
      PEAK_HOURS_START:   "18:00"
      PEAK_HOURS_END:     "22:00"

      POLL_SECONDS: "150"
      PEAK_POLL_SECONDS: "120"
      MAX_FIXTURES_PER_CYCLE: "12"
      PEAK_MAX_FIXTURES_PER_CYCLE: "16"
      RUN_MINUTES: "8"

      ENABLE_NEXT_GOAL: "1"
      ENABLE_OVER:      "1"
      ENABLE_DNB:       "1"
      ENABLE_LATE_GOAL: "1"
      ENABLE_UNDER:     "0"

      # ÚJ PIACOK
      ENABLE_BTTS: "1"
      ENABLE_TEAM_OVER: "1"
      ENABLE_CORNERS: "1"

      # Küszöbök (opcionálisan finomhangolhatók)
      OVER_MINUTE_START: "42"
      OVER_HARD_STOP:    "88"
      OVER_XG_SUM:       "1.20"
      OVER_SHOTS_SUM:    "4"
      OVER_REQUIRE_XG:   "0"

      LATE_MINUTE_START: "68"
      LATE_XG_SUM:       "1.60"
      LATE_SHOTS_SUM:    "9"
      LATE_DA_RUN:       "10"
      LATE_REQUIRE_XG:   "0"

      NG_DOM: "1.35"
      NG_SHOTS: "1.30"
      NG_XG: "1.25"
      NG_REQUIRE_XG: "0"

      DNB_DOM: "1.45"
      DNB_SHOTS: "1.35"
      DNB_XG: "1.25"
      DNB_REQUIRE_XG: "0"

      # BTTS
      BTTS_MINUTE_START: "30"
      BTTS_MIN_SOT_EACH: "2"
      BTTS_MIN_XG_EACH:  "0.4"
      BTTS_REQUIRE_XG:   "0"

      # TEAM OVER
      TEAM_OVER_MINUTE_START: "40"
      TEAM_OVER_XG_DIFF:      "0.6"
      TEAM_OVER_DA_RATIO:     "1.5"

      # CORNERS
      CORNERS_MINUTE_START:  "35"
      CORNERS_MIN_DA_SUM:    "20"
      CORNERS_MIN_SHOTS_SUM: "12"

      SIGNAL_COOLDOWN_MIN: "7"
      MARKET_COOLDOWN_MIN: "10"
      STATS_COOLDOWN_MIN: "5"
      MAX_SIGNALS_PER_DAY: "60"
      ENABLE_RED_CARD_FILTER: "1"

      MUTE_NO_SIGNAL: "1"
      SEND_ONLINE_ON_START: "0"
      DEBUG_LOG: "1"
      BACKOFF_MAX_SEC: "60"

      # Odds megjelenítés + minimumok
      ODDS_MODE: "shown"        # shown | none
      ODDS_BOOKMAKER: "bet365"
      OVER_MIN_ODDS: "1.25"
      BTTS_MIN_ODDS: "1.25"
      TEAM_OVER_MIN_ODDS: "1.25"
      CORNERS_MIN_ODDS: "1.25"

      SUMMARY_CMD_WINDOW_SEC: "120"

    steps:
      # Védő lépés: ha mégis az ablakon kívül indul, lépjen ki azonnal.
      - name: Check active window (Budapest time)
        id: timecheck
        run: |
          H=$(TZ=Europe/Budapest date +%H)
          M=$(TZ=Europe/Budapest date +%M)
          if [ "$H" -ge 5 ] && [ "$H" -lt 23 ]; then
            echo "within=true" >> "$GITHUB_OUTPUT"
            echo "Within active window: $H:$M (BUD)"
          else
            echo "within=false" >> "$GITHUB_OUTPUT"
            echo "Outside active window: $H:$M (BUD) → exit 0"
          fi

      - name: Checkout repository
        if: steps.timecheck.outputs.within == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.timecheck.outputs.within == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.timecheck.outputs.within == 'true'
        run: |
          pip install -r requirements.txt

      - name: Run LiveMesterBot
        if: steps.timecheck.outputs.within == 'true'
        run: |
          python livemesterbot.py

      - name: Persist today's events into data/YYYY-MM-DD
        if: always() && steps.timecheck.outputs.within == 'true'
        run: |
          set -e
          if [ -f logs/events.csv ]; then
            DATE=$(TZ="Europe/Budapest" date +%F)
            mkdir -p "data/${DATE}"
            if [ -f "data/${DATE}/events.csv" ]; then
              tail -n +2 logs/events.csv >> "data/${DATE}/events.csv" || true
            else
              cp logs/events.csv "data/${DATE}/events.csv"
            fi
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "data/${DATE}/events.csv"
            git commit -m "chore: persist events for ${DATE} [skip ci]" || echo "No changes"
            git push
          else
            echo "No local logs/events.csv produced in this run."
          fi

      - name: Upload logs artifact
        if: always() && steps.timecheck.outputs.within == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_id }}
          path: |
            logs/**
          if-no-files-found: ignore
          retention-days: 3

  # ===========================
  # 2) REGGELI NAPI ÖSSZEGZŐ
  # ===========================
  daily-summary:
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '5 5 * * *'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: "-1002780259470"
      RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      RAPIDAPI_HOST: "api-football-v1.p.rapidapi.com"
      TIMEZONE: "Europe/Budapest"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run daily summary for YESTERDAY (Budapest)
        env:
          SUMMARY_DATE: ${{ env.SUMMARY_DATE }}
        run: |
          # SUMMARY_DATE = tegnapi nap (BUD időzóna)
          export SUMMARY_DATE=$(TZ=Europe/Budapest date -d "yesterday" +%F)
          echo "SUMMARY_DATE=${SUMMARY_DATE}"
          python daily_summary.py
