name: LiveMesterBot

on:
  workflow_dispatch:
  schedule:
    # 10 percenként indul. (A cron UTC-ben van; a bot amúgy is csak 05:00–23:00 között aktív BUD idő szerint.)
    - cron: "*/10 * * * *"

concurrency:
  group: livemesterbot
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      # --- Kötelező kulcsok (Secrets-ben tárolva) ---
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: "-1002780259470"

      RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      RAPIDAPI_HOST: "api-football-v1.p.rapidapi.com"

      # --- Üzemidő / gyakoriság / limit ---
      TIMEZONE: "Europe/Budapest"
      ACTIVE_HOURS_START: "05:00"
      ACTIVE_HOURS_END:   "23:00"
      PEAK_HOURS_START:   "18:00"
      PEAK_HOURS_END:     "22:00"

      POLL_SECONDS: "150"
      PEAK_POLL_SECONDS: "120"
      MAX_FIXTURES_PER_CYCLE: "12"
      PEAK_MAX_FIXTURES_PER_CYCLE: "16"

      # A runneren 8 percig fut egy ciklus; 10 perces triggert használunk, így szépen leáll és nem fut párhuzamosan.
      RUN_MINUTES: "8"

      # --- Piac-kapcsolók és küszöbök (jó defaultok) ---
      ENABLE_NEXT_GOAL: "1"
      ENABLE_OVER:      "1"
      ENABLE_DNB:       "1"
      ENABLE_LATE_GOAL: "1"
      ENABLE_UNDER:     "0"

      OVER_MINUTE_START: "42"
      OVER_HARD_STOP:    "88"
      OVER_XG_SUM:       "1.20"
      OVER_SHOTS_SUM:    "4"
      OVER_REQUIRE_XG:   "0"

      LATE_MINUTE_START: "68"
      LATE_XG_SUM:       "1.60"
      LATE_SHOTS_SUM:    "9"
      LATE_DA_RUN:       "10"
      LATE_REQUIRE_XG:   "0"

      NG_DOM: "1.35"
      NG_SHOTS: "1.30"
      NG_XG: "1.25"
      NG_REQUIRE_XG: "0"

      DNB_DOM: "1.45"
      DNB_SHOTS: "1.35"
      DNB_XG: "1.25"
      DNB_REQUIRE_XG: "0"

      SIGNAL_COOLDOWN_MIN: "7"
      MARKET_COOLDOWN_MIN: "10"
      STATS_COOLDOWN_MIN: "5"
      MAX_SIGNALS_PER_DAY: "60"
      ENABLE_RED_CARD_FILTER: "1"

      # --- Üzenetküldés / debug ---
      MUTE_NO_SIGNAL: "1"
      SEND_ONLINE_ON_START: "0"
      DEBUG_LOG: "1"
      BACKOFF_MAX_SEC: "60"

      # --- ODDS beállítások (EZEKET kérted) ---
      ODDS_MODE: "shown"        # élő odds lekérés bekapcsolása
      ODDS_BOOKMAKER: "bet365"  # preferált bukméker (opcionális)
      OVER_MIN_ODDS: "1.25"     # ez alatti Over árnál NEM küld jelzést

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run LiveMesterBot
        run: |
          python livemesterbot.py

      # Opcionális log-artifact a futás végén (mindig lefut)
      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_id }}
          path: |
            logs/**
          if-no-files-found: ignore
          retention-days: 3
