name: LiveMesterBot (batch)

# Egyszerre csak 1 fusson, a k√∂vetkez≈ë sorban √°ll (nem l√∂vi le a fut√≥t)
concurrency:
  group: livemesterbot
  cancel-in-progress: false

# 05:00‚Äì23:00 Europe/Budapest ‚Üí t√©li id≈ëben UTC 04‚Äì22
on:
  schedule:
    - cron: "*/15 4-22 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run LiveMesterBot (8-min session; cron restarts)
        timeout-minutes: 12
        run: python livemesterbot.py
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: api-football-v1.p.rapidapi.com

          # Id≈ëz√≠t√©s & k√©r√©s-keret (‚âà ‚â§5000/nap)
          POLL_SECONDS: "150"
          ACTIVE_HOURS_START: "05:00"
          ACTIVE_HOURS_END: "23:00"
          PEAK_HOURS_START: "18:00"
          PEAK_HOURS_END: "22:00"
          PEAK_POLL_SECONDS: "120"

          # Ciklusonk√©nt statolt meccsek
          MAX_FIXTURES_PER_CYCLE: "12"
          PEAK_MAX_FIXTURES_PER_CYCLE: "16"

          # Ugyanarra a meccsre stat cooldown (perc)
          STATS_COOLDOWN_MIN: "5"

          TIMEZONE: Europe/Budapest

          # Fut√°si modell
          RUN_MINUTES: "8"
          MUTE_NO_SIGNAL: "1"
          SEND_ONLINE_ON_START: "0"
          BACKOFF_MAX_SEC: "60"

          # Piacok
          ENABLE_NEXT_GOAL: "1"
          ENABLE_OVER: "1"
          ENABLE_DNB: "1"
          ENABLE_LATE_GOAL: "1"
          ENABLE_UNDER: "0"

          # --- K√úSZ√ñB√ñK (v2.3 alap + k√©rt v√°ltoz√°s) ---
          # NEXT_GOAL (xG opcion√°lis)
          NG_DOM: "1.35"
          NG_SHOTS: "1.30"
          NG_XG: "1.25"
          NG_REQUIRE_XG: "0"

          # OVER ‚Äì csak 42' ut√°n √©s HT-ben tiltva
          OVER_MINUTE_START: "42"
          OVER_XG_SUM: "1.20"
          OVER_SHOTS_SUM: "4"
          OVER_REQUIRE_XG: "0"

          # DNB
          DNB_DOM: "1.45"
          DNB_SHOTS: "1.35"
          DNB_XG: "1.25"
          DNB_REQUIRE_XG: "0"

          # LATE GOAL
          LATE_MINUTE_START: "68"
          LATE_XG_SUM: "1.60"
          LATE_SHOTS_SUM: "9"
          LATE_DA_RUN: "10"
          LATE_REQUIRE_XG: "0"

          # Anti-spam
          SIGNAL_COOLDOWN_MIN: "7"
          MARKET_COOLDOWN_MIN: "10"

          # Piros lap sz≈±r√©s
          ENABLE_RED_CARD_FILTER: "1"     # 1 = OVER + NEXT_GOAL jelz√©sek piros lapn√°l tiltva

          # Napi fels≈ë jel-limit
          MAX_SIGNALS_PER_DAY: "60"

          # DEBUG (csendben f√°jlba)
          DEBUG_LOG: "1"

      # Napl√≥ commit√°l√°sa (HA √©s CSAK HA van √∫j events.csv)
      - name: Commit logs to repo (data/YYYY-MM-DD/events.csv)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          DATE=$(TZ=Europe/Budapest date +%F)
          SRC="logs/events.csv"
          TARGET_DIR="data/$DATE"
          TARGET="$TARGET_DIR/events.csv"

          echo "üìÑ Commit step ‚Äì DATE=$DATE"
          echo "SRC=$SRC"
          echo "TARGET=$TARGET"

          # Ha nincs helyi log, nincs mit commitolni
          if [ ! -s "$SRC" ]; then
            echo "‚ÑπÔ∏è Nincs helyi $SRC (nem keletkezett tipp ebben a fut√°sban)."
            exit 0
          fi

          mkdir -p "$TARGET_DIR"

          if [ -f "$TARGET" ]; then
            echo "‚ûï F≈±z√©s megl√©v≈ë napi f√°jlhoz: $TARGET"
            tail -n +2 "$SRC" >> "$TARGET" || { echo "‚ùó tail >> sikertelen"; exit 0; }
          else
            echo "üÜï √öj napi f√°jl l√©trehoz√°sa: $TARGET"
            cp "$SRC" "$TARGET" || { echo "‚ùó cp sikertelen"; exit 0; }
          fi

          if [ ! -f "$TARGET" ]; then
            echo "‚ùó A c√©lf√°jl nem l√©tezik a m√°sol√°s ut√°n sem, commit l√©p√©s kihagyva."
            ls -la logs || true
            ls -la "$TARGET_DIR" || true
            exit 0
          fi

          echo "‚úÖ Napi f√°jl k√©sz, commitol√°s..."
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "$TARGET" || { echo "‚ùó git add sikertelen, de nem bukjuk a jobot."; exit 0; }
          git commit -m "chore(data): append events $DATE [skip ci]" || { echo "‚ÑπÔ∏è Nincs v√°ltoz√°s."; exit 0; }
          git push || { echo "‚ùó git push sikertelen (pl. nincs v√°ltoz√°s / h√°l√≥zat)."; exit 0; }

      - name: Finish
        run: echo "‚úÖ LiveMesterBot workflow complete."
