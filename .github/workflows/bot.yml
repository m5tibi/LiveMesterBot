name: LiveMesterBot (batch)

# Ne fusson pÃ¡rhuzamosan
concurrency:
  group: livemesterbot
  cancel-in-progress: true

# 05:00â€“23:00 Europe/Budapest â†’ UTC-ben 04â€“22
on:
  schedule:
    - cron: "*/15 4-22 * * *"   # 15 percenkÃ©nt 05:00â€“23:00 CET (UTC+1 => 04â€“22 UTC)
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run LiveMesterBot (10-min session; cron restarts)
        run: python livemesterbot.py
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: api-football-v1.p.rapidapi.com

          # IdÅ‘zÃ­tÃ©s Ã©s kÃ©rÃ©s-keret (â‰ˆ â‰¤5000/nap)
          POLL_SECONDS: "150"             # 2.5 perc
          ACTIVE_HOURS_START: "05:00"
          ACTIVE_HOURS_END: "23:00"
          PEAK_HOURS_START: "18:00"
          PEAK_HOURS_END: "22:00"
          PEAK_POLL_SECONDS: "120"        # csÃºcsban 2 perc

          # CiklusonkÃ©nt ennyi meccsre kÃ©rÃ¼nk statot
          MAX_FIXTURES_PER_CYCLE: "12"
          PEAK_MAX_FIXTURES_PER_CYCLE: "16"

          # Ugyanarra a meccsre min. ennyi perc kÃ©t statlekÃ©rÃ©s kÃ¶zÃ¶tt
          STATS_COOLDOWN_MIN: "5"

          TIMEZONE: Europe/Budapest

          # FutÃ¡si modell
          RUN_MINUTES: "10"               # 10 perc futÃ¡s / job
          MUTE_NO_SIGNAL: "1"             # ne kÃ¼ldjÃ¶n 'nincs jel' Ã¼zeneteket
          SEND_ONLINE_ON_START: "0"       # ðŸ”• indulÃ¡skor NE kÃ¼ldjÃ¶n 'online' Ã¼zenetet

          # Piacok engedÃ©lyezÃ©se
          ENABLE_NEXT_GOAL: "1"
          ENABLE_OVER: "1"
          ENABLE_DNB: "1"
          ENABLE_LATE_GOAL: "1"
          ENABLE_UNDER: "0"               # kÃ©sÅ‘bb bekapcsolhatÃ³

          # KÃ¼szÃ¶bÃ¶k (finomhangolhatÃ³k)
          NG_DOM: "1.6"
          NG_SHOTS: "1.5"
          NG_XG: "1.4"

          OVER_MINUTE_START: "45"
          OVER_XG_SUM: "1.6"
          OVER_SHOTS_SUM: "6"

          DNB_DOM: "1.6"
          DNB_SHOTS: "1.5"
          DNB_XG: "1.4"

          LATE_MINUTE_START: "70"
          LATE_XG_SUM: "2.0"
          LATE_SHOTS_SUM: "12"
          LATE_DA_RUN: "15"               # utolsÃ³ ~10 percben veszÃ©lyes tÃ¡madÃ¡s-run

          # Jel-anti-spam
          SIGNAL_COOLDOWN_MIN: "7"        # ugyanarra a meccsre min. 7 perc kÃ©t jel kÃ¶zÃ¶tt
          MARKET_COOLDOWN_MIN: "10"       # ugyanarra a piacra min. 10 perc

      # NaplÃ³ commitÃ¡lÃ¡sa (ha keletkezett jel)
      - name: Commit logs to repo (data/YYYY-MM-DD/events.csv)
        if: always()
        run: |
          set -e
          DATE=$(TZ=Europe/Budapest date +%F)
          mkdir -p "data/$DATE"
          TARGET="data/$DATE/events.csv"
          if [ -f logs/events.csv ]; then
            if [ -f "$TARGET" ]; then
              tail -n +2 logs/events.csv >> "$TARGET"
            else
              cp logs/events.csv "$TARGET"
            fi
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add "$TARGET"
            git commit -m "chore(data): append events $DATE [skip ci]" || echo "No changes"
            git push
          else:
            echo "No local logs/events.csv produced in this run."
          fi

      - name: Finish
        run: echo "âœ… LiveMesterBot workflow complete."
